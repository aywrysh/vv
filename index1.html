<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إنشاء حساب | نظام الشركة</title>

  <!-- خط وأيقونة -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --accent:#BBCF38; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --card:#fff; --bg:#f6f7f9; --radius:14px; --top:60px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}

    /* شريط علوي بسيط */
    .topbar{
      position:fixed; inset-inline:0; top:0; height:var(--top); background:var(--card);
      border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; padding:0 16px; z-index:10;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand .dot{width:14px;height:14px;border-radius:50%;background:var(--accent)}
    .btn{display:grid;place-items:center;width:40px;height:40px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .ms{font-family:'Material Symbols Rounded'}

    /* الحاوية */
    .wrap{min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:calc(var(--top) + 24px) 16px 24px}
    .card{
      width:min(520px,92vw); background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:0 10px 24px rgba(0,0,0,.06); padding:18px;
    }
    h1{margin:0 0 6px; font-size:22px}
    .sub{margin:0 0 14px; color:var(--muted); font-size:14px}

    .field{display:grid; gap:8px; margin:10px 0}
    .label{font-weight:900; font-size:13px}
    .input{
      padding:12px; border:1px solid var(--line); border-radius:12px; background:#fafafa; font-weight:700; width:100%;
    }
    .input:focus{outline:none; border-color:#cdd5e0; background:#fff}
    .input[dir="ltr"]{direction:ltr}
    .input.error{border-color:#ef4444; background:#fff1f1}
    .hint{font-size:12px; color:var(--muted)}

    .actions{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
    .btn-solid{flex:1; padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:#fff; font-weight:900; cursor:pointer}
    .btn-solid.primary{background:var(--accent); border-color:var(--accent); color:#111}

    .toast{
      position:fixed; bottom:22px; left:50%; transform:translateX(-50%) scale(.96);
      background:rgba(17,17,17,.92); color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; font-size:12px;
      opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:30;
    }
    .toast.show{opacity:1; transform:translateX(-50%) scale(1)}
  </style>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#BBCF38">
</head>
<body>

  <!-- الشريط العلوي -->
  <header class="topbar">
    <div class="brand"><span class="dot"></span><span>نظام الشركة</span></div>
    <button class="btn" id="backBtn" title="رجوع"><span class="ms">arrow_back_ios_new</span></button>
  </header>

  <!-- المحتوى -->
  <main class="wrap">
    <section class="card" aria-labelledby="title">
      <h1 id="title">إنشاء حساب</h1>
      <p class="sub">أدخل بيانات الحساب الأساسية.</p>

      <div class="field">
        <label class="label" for="name">الاسم الكامل</label>
        <input id="name" class="input" type="text" placeholder="اسم المستخدم">
      </div>

      <div class="field">
        <label class="label" for="phone">رقم الهاتف</label>
        <input id="phone" class="input" type="tel" inputmode="tel" dir="ltr" placeholder="+967 7XXXXXXXX">
        <div class="hint">يكفي رقم يحتوي 7 أرقام أو أكثر.</div>
      </div>

      <!-- اسم المستخدم (تلقائي) — وجوده اختياري للعرض فقط -->
      <div class="field" style="">
        <label class="label" for="uname">اسم المستخدم (تلقائي)</label>
        <div style="display:flex; gap:8px; align-items:center">
          <input id="uname" class="input" type="text" placeholder="سيُولَّد تلقائيًا" readonly>
          <button class="btn" id="regenU" title="تجديد"><span class="ms">refresh</span></button>
        </div>
        <div class="hint">7 أحرف إنجليزية (كبيرة وصغيرة).</div>
      </div>

      <div class="field">
        <label class="label" for="pwd">كلمة المرور</label>
        <input id="pwd" class="input" type="password" placeholder="••••••••">
      </div>

      <div class="field">
        <label class="label" for="cpwd">تأكيد كلمة المرور</label>
        <input id="cpwd" class="input" type="password" placeholder="••••••••">
      </div>

      <div class="actions">
        <button class="btn-solid" id="cancelBtn">إلغاء</button>
        <button class="btn-solid primary" id="createBtn">إنشاء الحساب</button>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Firebase + منطق الصفحة -->
  <script type="module">
    /* ============ Firebase إعداد ============ */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, push, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* ============ أدوات واجهة ============ */
    const $ = s => document.querySelector(s);
    function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1500); }
    function validPhoneLoose(v){ return (String(v||'').replace(/\D/g,'').length >= 7); }

    // توليد ID رقمي 9 خانات يبدأ بـ 99
    function genAccountId(){
      const rest = Math.floor(Math.random()*1e7).toString().padStart(7,'0'); // 7 خانات
      return `99${rest}`; // المجموع 9 خانات
    }
    // رمز دعوة 6 خانات
    function genInviteCode(len=6){
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out=''; for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    // اسم مستخدم عشوائي محلي (بدون شبكة)
    function genUsernameLocal(len=7){
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
      let out=''; for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    // فحص تفرّد الاسم مع بديل محلي
    async function freshUsernameSafe(){
      let candidate = genUsernameLocal();
      try{
        for(let t=0; t<5; t++){
          const u = (t===0)? candidate : genUsernameLocal();
          const snap = await get(ref(db, 'usernames/'+u));
          if(!snap.exists()) return u;
        }
      }catch(e){
        console.warn('freshUsername check failed, using local fallback:', e);
      }
      return candidate;
    }

    // مسار الداشبورد بعد النجاح (عدّله لصفحتك الفعلية إن لزم)
    const DASHBOARD = "index.html";

    // أزرار أعلى الصفحة
    $("#backBtn").addEventListener('click', ()=>{
      if(history.length>1) history.back(); else window.location.replace(DASHBOARD);
    });
    $("#cancelBtn").addEventListener('click', ()=>{
      if(history.length>1) history.back(); else window.location.replace(DASHBOARD);
    });

    // متغيّر مركزي لاسم المستخدم (حتى لو الحقل مخفي)
    let usernameVar = null;

    // تهيئة اسم المستخدم التلقائي (يعطي قيمة فورية ثم يحاول الفحص)
    const unameInput = $("#uname");  // قد يكون مخفيًا — لا يعتمد عليه الحفظ
    (async ()=>{
      // قيمة فورية تظهر للمستخدم (إن كان الحقل ظاهر)
      usernameVar = genUsernameLocal();
      if (unameInput) unameInput.value = usernameVar;

      try{
        const u = await freshUsernameSafe();
        usernameVar = u;
        if (unameInput) unameInput.value = u; // تحديث للعرض فقط
      }catch{ /* البديل المحلي يكفي */ }
    })();

    // زر التحديث (اختياري للعرض فقط)
    $("#regenU").addEventListener('click', async ()=>{
      const btn = $("#regenU");
      btn.disabled = true;
      try{
        const u = await freshUsernameSafe();
        usernameVar = u;
        if (unameInput) unameInput.value = u;
        toast('تم توليد اسم جديد');
      }finally{
        btn.disabled = false;
      }
    });

    // إنشاء الحساب وحفظه بفirebase
    $("#createBtn").addEventListener('click', async ()=>{
      const name = $("#name");
      const phone = $("#phone");
      const pwd = $("#pwd");
      const cpwd = $("#cpwd");

      [name,phone,pwd,cpwd].forEach(i=>i.classList.remove('error'));

      // تحقق أساسي
      if(!name.value.trim()){ name.classList.add('error'); name.focus(); return toast('أدخل الاسم'); }
      if(!validPhoneLoose(phone.value)){ phone.classList.add('error'); phone.focus(); return toast('رقم هاتف غير صالح'); }
      if((pwd.value||'').length < 6){ pwd.classList.add('error'); pwd.focus(); return toast('كلمة المرور قصيرة (6+)'); }
      if(pwd.value !== cpwd.value){ cpwd.classList.add('error'); cpwd.focus(); return toast('كلمتا المرور غير متطابقتين'); }

      // تأمين اسم المستخدم حتى لو الحقل مخفي/فارغ
      let finalUsername = usernameVar && String(usernameVar).trim();
      if(!finalUsername || finalUsername.length < 3){
        finalUsername = await freshUsernameSafe();
        usernameVar = finalUsername;
        if (unameInput) unameInput.value = finalUsername;
      }

      // تعطيل الزر مؤقتاً
      const btn = $("#createBtn"); const prev = btn.textContent; btn.disabled = true; btn.textContent = 'جارٍ الحفظ...';

      try{
        // مراجع
        const usersRef = ref(db, "users");
        const newRef   = push(usersRef);           // uid فريد للصف
        const uid      = newRef.key;

        const accountId  = genAccountId();         // 9 خانات يبدأ بـ 99
        const inviteCode = genInviteCode();        // 6 خانات

        // ⚠️ تخزين كلمة المرور نصّياً كما طلبت (غير آمن إنتاجياً)
        const data = {
          uid,
          accountId,              // مثال: 991234567
          username: finalUsername,
          name: name.value.trim(),
          phone: phone.value.trim(),
          password: pwd.value,    // ← نص واضح حسب طلبك
          balance: 0,             // الرصيد
          lockedAmount: 0,        // مبلغ العقد المقفل
          inviteCode,             // رمز الدعوة
          createdAt: serverTimestamp()
        };

        // حفظ المستخدم
        await set(newRef, data);

        // فهرس سريع للبحث عن اسم المستخدم → uid
        await set(ref(db, `usernames/${finalUsername}`), uid);

        // (اختياري) فهرس كود الدعوة -> uid
        await set(ref(db, `invites/${inviteCode}`), { uid, createdAt: serverTimestamp() });

        toast('تم إنشاء الحساب');
        setTimeout(()=> window.location.replace(DASHBOARD), 900);
      }catch(err){
        console.error('Create account failed:', err);
        toast('تعذّر الحفظ، حاول مرة أخرى');
      }finally{
        btn.disabled = false; btn.textContent = prev;
      }
    });
  </script>

  <!-- ملاحظة: لتعطيل أي كاش قديم للـSW على صفحات GitHub استعمل نسخة محدثة -->
  <script>
    // مؤقتًا: لا نسجل SW لتفادي صفحة بيضاء من كاش قديم.
    // إذا احتجته لاحقًا فعّله بإصدار مثل:
    // if ("serviceWorker" in navigator) {
    //   navigator.serviceWorker.register("service-worker.js?v=2");
    // }
  </script>
</body>
</html>